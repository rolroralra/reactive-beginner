# Spring WebFlux 시작하기

## 1. 프로젝트 생성

### 1.1 Spring Initializr 사용

[Spring Initializr](https://start.spring.io/)에서 다음 설정으로 프로젝트를 생성합니다.

- **Project**: Gradle - Groovy 또는 Maven
- **Language**: Java
- **Spring Boot**: 3.x
- **Dependencies**: Spring Reactive Web

### 1.2 Gradle 설정

```groovy
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.2.0'
    id 'io.spring.dependency-management' version '1.1.4'
}

group = 'com.example'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'io.projectreactor:reactor-test'
}

tasks.named('test') {
    useJUnitPlatform()
}
```

### 1.3 Maven 설정

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
         https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.0</version>
    </parent>

    <groupId>com.example</groupId>
    <artifactId>webflux-demo</artifactId>
    <version>0.0.1-SNAPSHOT</version>

    <properties>
        <java.version>17</java.version>
    </properties>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>
</project>
```

## 2. 첫 번째 애플리케이션

### 2.1 메인 클래스

```java
package com.example.webflux;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class WebFluxApplication {
    public static void main(String[] args) {
        SpringApplication.run(WebFluxApplication.class, args);
    }
}
```

### 2.2 간단한 Controller

```java
package com.example.webflux.controller;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
import reactor.core.publisher.Mono;

@RestController
public class HelloController {

    @GetMapping("/hello")
    public Mono<String> hello() {
        return Mono.just("Hello, WebFlux!");
    }
}
```

### 2.3 실행 및 테스트

```bash
# 애플리케이션 실행
./gradlew bootRun

# 테스트
curl http://localhost:8080/hello
# 결과: Hello, WebFlux!
```

## 3. 프로젝트 구조

```
src/
├── main/
│   ├── java/
│   │   └── com/example/webflux/
│   │       ├── WebFluxApplication.java
│   │       ├── controller/
│   │       │   └── UserController.java
│   │       ├── handler/
│   │       │   └── UserHandler.java
│   │       ├── router/
│   │       │   └── RouterConfig.java
│   │       ├── service/
│   │       │   └── UserService.java
│   │       ├── repository/
│   │       │   └── UserRepository.java
│   │       ├── model/
│   │       │   └── User.java
│   │       └── config/
│   │           └── WebFluxConfig.java
│   └── resources/
│       └── application.yml
└── test/
    └── java/
        └── com/example/webflux/
            └── controller/
                └── UserControllerTest.java
```

## 4. 기본 설정

### 4.1 application.yml

```yaml
server:
  port: 8080

spring:
  webflux:
    base-path: /api  # 기본 경로 설정 (선택)

logging:
  level:
    root: INFO
    org.springframework.web: DEBUG
    reactor.netty: DEBUG
```

### 4.2 Netty 서버 설정

```java
package com.example.webflux.config;

import org.springframework.boot.web.embedded.netty.NettyReactiveWebServerFactory;
import org.springframework.boot.web.server.WebServerFactoryCustomizer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class NettyConfig {

    @Bean
    public WebServerFactoryCustomizer<NettyReactiveWebServerFactory> nettyCustomizer() {
        return factory -> {
            factory.setPort(8080);
            factory.addServerCustomizers(httpServer ->
                httpServer
                    .wiretap(true)  // 디버깅용 로그
                    .compress(true) // 응답 압축
            );
        };
    }
}
```

## 5. 간단한 CRUD 예제

### 5.1 Model

```java
package com.example.webflux.model;

public class User {
    private Long id;
    private String name;
    private String email;

    public User() {}

    public User(Long id, String name, String email) {
        this.id = id;
        this.name = name;
        this.email = email;
    }

    // Getters and Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    public String getEmail() { return email; }
    public void setEmail(String email) { this.email = email; }
}
```

### 5.2 Repository (In-Memory)

```java
package com.example.webflux.repository;

import com.example.webflux.model.User;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.atomic.AtomicLong;

@Repository
public class UserRepository {

    private final Map<Long, User> users = new ConcurrentHashMap<>();
    private final AtomicLong idGenerator = new AtomicLong(1);

    public Mono<User> findById(Long id) {
        return Mono.justOrEmpty(users.get(id));
    }

    public Flux<User> findAll() {
        return Flux.fromIterable(users.values());
    }

    public Mono<User> save(User user) {
        if (user.getId() == null) {
            user.setId(idGenerator.getAndIncrement());
        }
        users.put(user.getId(), user);
        return Mono.just(user);
    }

    public Mono<Void> deleteById(Long id) {
        users.remove(id);
        return Mono.empty();
    }
}
```

### 5.3 Service

```java
package com.example.webflux.service;

import com.example.webflux.model.User;
import com.example.webflux.repository.UserRepository;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Service
public class UserService {

    private final UserRepository userRepository;

    public UserService(UserRepository userRepository) {
        this.userRepository = userRepository;
    }

    public Mono<User> findById(Long id) {
        return userRepository.findById(id);
    }

    public Flux<User> findAll() {
        return userRepository.findAll();
    }

    public Mono<User> save(User user) {
        return userRepository.save(user);
    }

    public Mono<Void> deleteById(Long id) {
        return userRepository.deleteById(id);
    }
}
```

### 5.4 Controller

```java
package com.example.webflux.controller;

import com.example.webflux.model.User;
import com.example.webflux.service.UserService;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@RestController
@RequestMapping("/users")
public class UserController {

    private final UserService userService;

    public UserController(UserService userService) {
        this.userService = userService;
    }

    @GetMapping("/{id}")
    public Mono<ResponseEntity<User>> getUser(@PathVariable Long id) {
        return userService.findById(id)
            .map(ResponseEntity::ok)
            .defaultIfEmpty(ResponseEntity.notFound().build());
    }

    @GetMapping
    public Flux<User> getAllUsers() {
        return userService.findAll();
    }

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    public Mono<User> createUser(@RequestBody User user) {
        return userService.save(user);
    }

    @PutMapping("/{id}")
    public Mono<ResponseEntity<User>> updateUser(
            @PathVariable Long id,
            @RequestBody User user) {
        return userService.findById(id)
            .flatMap(existingUser -> {
                user.setId(id);
                return userService.save(user);
            })
            .map(ResponseEntity::ok)
            .defaultIfEmpty(ResponseEntity.notFound().build());
    }

    @DeleteMapping("/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    public Mono<Void> deleteUser(@PathVariable Long id) {
        return userService.deleteById(id);
    }
}
```

## 6. API 테스트

### 6.1 사용자 생성

```bash
curl -X POST http://localhost:8080/users \
  -H "Content-Type: application/json" \
  -d '{"name": "홍길동", "email": "hong@example.com"}'
```

### 6.2 사용자 조회

```bash
# 단일 조회
curl http://localhost:8080/users/1

# 전체 조회
curl http://localhost:8080/users
```

### 6.3 사용자 수정

```bash
curl -X PUT http://localhost:8080/users/1 \
  -H "Content-Type: application/json" \
  -d '{"name": "홍길동", "email": "hong.updated@example.com"}'
```

### 6.4 사용자 삭제

```bash
curl -X DELETE http://localhost:8080/users/1
```

## 7. 다음 단계

- [Annotated Controllers](03_Annotated_Controllers.md): 어노테이션 기반 상세 가이드
- [Functional Endpoints](04_Functional_Endpoints.md): 함수형 엔드포인트 가이드
- [WebClient](05_WebClient.md): 리액티브 HTTP 클라이언트
